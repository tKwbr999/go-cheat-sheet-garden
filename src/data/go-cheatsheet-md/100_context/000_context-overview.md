---
title: "Context パッケージ: 概要"
tags: ["context", "concurrency", "キャンセル", "タイムアウト", "デッドライン", "値伝達", "リクエストスコープ"]
---

Go言語の標準ライブラリ **`context`** パッケージは、特にサーバーサイドアプリケーションや分散システム、あるいは複数の Goroutine にまたがる処理において、非常に重要な役割を果たします。

`import "context"` として利用します。

## `context` パッケージの目的

`context` パッケージは、主に以下の情報を**関数呼び出しの連鎖や Goroutine 間で伝達**するための標準的な仕組みを提供します。

1.  **キャンセルシグナル (Cancellation Signal):**
    *   ある処理（例: HTTPリクエストの処理）が不要になった場合（例: ユーザーがリクエストをキャンセルした、関連する処理がエラーになった）、その処理に関連するすべての Goroutine に対して「処理を中断してください」というシグナルを送ることができます。
    *   これにより、不要な計算やリソースの消費を早期に停止させることができます。
2.  **タイムアウト (Timeout) / デッドライン (Deadline):**
    *   処理に時間制限を設けたい場合に利用します。指定した時間が経過したり、指定した時刻になったりすると、自動的にキャンセルシグナルが送られます。
    *   外部API呼び出しやデータベースクエリなど、応答時間が保証されない処理に対して、無期限に待ち続けるのを防ぐために不可欠です。
3.  **リクエストスコープの値 (Request-Scoped Values):**
    *   一つのリクエスト（例: HTTPリクエスト）に関連する情報（リクエストID、ユーザー認証情報、トレース情報など）を、そのリクエスト処理に関わる様々な関数や Goroutine に安全に渡すための仕組みです。

## `context.Context` インターフェース

これらの機能は、`context.Context` というインターフェースを通じて提供されます。

```go
type Context interface {
    // Deadline は、この Context がキャンセルされる時刻を返します。
    // デッドラインが設定されていない場合は ok == false となります。
    Deadline() (deadline time.Time, ok bool)

    // Done はチャネルを返します。このチャネルは、
    // この Context で行うべき作業がキャンセルされるとクローズされます。
    // Done が nil を返す場合、この Context は決してキャンセルされません。
    Done() <-chan struct{}

    // Err は、Done チャネルがクローズされた後、Context がキャンセルされた理由を返します。
    // キャンセルされていなければ nil を返します。
    Err() error // 通常 context.Canceled または context.DeadlineExceeded を返す

    // Value は、この Context に関連付けられたキーに対応する値を返します。
    // キーが見つからない場合は nil を返します。
    Value(key any) any
}
```

**ポイント:**

*   `Done()` メソッドが返すチャネルは、Context のキャンセルを検知するための主要なメカニズムです。`select` 文と組み合わせて使います。
*   `Err()` メソッドは、キャンセルが発生した**後**に、その理由（明示的なキャンセルか、タイムアウト/デッドラインか）を確認するために使います。
*   `Deadline()` メソッドは、タイムアウトやデッドラインが設定されているか、そしてそれはいつかを確認するために使います。
*   `Value()` メソッドは、Context に格納されたリクエストスコープの値を取得するために使います。

## なぜ Context が重要か？

*   **リソース管理:** 不要になった処理を早期にキャンセルすることで、CPU、メモリ、ネットワーク接続などのリソースを効率的に利用できます。
*   **応答性の向上:** タイムアウトを設定することで、一部の処理が遅延してもシステム全体が応答不能になるのを防ぎます。
*   **トレーサビリティ:** リクエストIDなどを Context で引き回すことで、分散システムにおけるリクエストの追跡やログの関連付けが容易になります。
*   **標準的な方法:** Go の多くの標準ライブラリやサードパーティライブラリ（データベースドライバ、HTTPクライアント/サーバーフレームワークなど）が `context.Context` を引数として受け入れるように設計されており、キャンセルやタイムアウトの機構を統一的に扱うことができます。

この後のセクションでは、Context の具体的な生成方法や使い方について詳しく見ていきます。